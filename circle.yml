machine:
  node:
    version: 6

  environment:
    NODE_ENV: test
    DATABASE_USERNAME: ubuntu

dependencies:
  pre:
    - |
      cd ../

      if [ -d watchman ]; then
        cd watchman
        sudo make install
      else
        git clone https://github.com/facebook/watchman.git
        cd watchman
        git checkout v4.7.0

        ./autogen.sh
        ./configure
        make
        sudo make install
      fi

      cd ../lux

  override:
    - npm install
    - npm link

  post:
    - |
      cd test/test-app
      npm install
      cd ../../

  cache_directories:
    - /home/ubuntu/watchman

test:
  pre:
    - psql -c 'DROP DATABASE IF EXISTS lux_test;' -U postgres:
        parallel: true

    - psql -c 'CREATE DATABASE lux_test;' -U postgres:
        parallel: true

    - mysql -e 'DROP DATABASE IF EXISTS lux_test;':
        parallel: true

    - mysql -e 'CREATE DATABASE lux_test;':
        parallel: true

    - npm run flow:
        parallel: true

    - npm run lint:
        parallel: true

    - npm run clean:
        parallel: true

    - npm run build:
        parallel: true

  override:
    - npm test -- -R mocha-junit-reporter:
        parallel: true
        environment:
          MOCHA_FILE: $CIRCLE_TEST_REPORTS/junit/test-results.xml

  post:
    - npm run codecov:
        parallel: true
